name: Docker Image CI

on:
  push:
    branches: [ main ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Docker login
      run : docker login -u ${{ secrets.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}
    - name: Build the Docker image
      run: docker build -t sflask:latest .
    - name: Tags
      run: |
        docker tag sflask ${{ secrets.DOCKER_USER }}/sflask:${{ github.sha }}
        docker tag sflask ${{ secrets.DOCKER_USER }}/sflask:latest
    - name: Push to docker hub
      run : |   
        docker push ${{ secrets.DOCKER_USER }}/sflask:latest
 
    - name: Capture failure reason
      if: failure()
      run: |
        echo "âŒ Build failed because one of the test scripts returned a non-zero exit code." > fail_reason.txt
        continue-on-error: true

    - name: Send deployment notification to ClickUp
      if: always()
      env:
        CLICKUP_WORKSPACE_ID: ${{ secrets.CLICKUP_WORKSPACE_ID }}
        CLICKUP_CHANNEL_ID: ${{ secrets.CLICKUP_CHANNEL_ID }}
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
      run: |
          REPO_LINK="https://github.com/${GITHUB_REPOSITORY}"
          COMMIT_LINK="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          
          if [ "${{ job.status }}" = "success" ]; then
            STATUS_ICON="ðŸŸ¢"
            STATUS_TEXT="**SUCCESS**"
            FAIL_REASON=""
          else
            STATUS_ICON="ðŸ”´"
            STATUS_TEXT="**FAILURE**"
            FAIL_REASON="\n**Reason:** $(cat fail_reason.txt)"
          fi
          
          MESSAGE="${STATUS_ICON} Build Status: ${STATUS_TEXT}
          **Repository:** [${GITHUB_REPOSITORY}](${REPO_LINK})  
          **Commit:** [${GITHUB_SHA::7}](${COMMIT_LINK})  
          **Description:** New changes apply on : \`${GITHUB_REPOSITORY}\`
          **Commit:** [${GITHUB_SHA::7}](${COMMIT_LINK})  
          **Repo:** [View Repo](${REPO_LINK})  
          **Pushed By:** ${GITHUB_ACTOR}
          **Triggered By:** ${GITHUB_ACTOR}${FAIL_REASON}"

          curl --request POST \
            --url "https://api.clickup.com/api/v3/workspaces/${CLICKUP_WORKSPACE_ID}/chat/channels/${CLICKUP_CHANNEL_ID}/messages" \
            --header "Authorization: ${CLICKUP_API_TOKEN}" \
            --header "accept: application/json" \
            --header "content-type: application/json" \
            --data "$(jq -n \
              --arg type "message" \
              --arg content_format "text/md" \
              --arg content "$MESSAGE" \
              '{type: $type, content_format: $content_format, content: $content}')"
