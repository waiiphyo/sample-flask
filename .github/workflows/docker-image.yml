name: Docker Image CI

on:
  push:
    branches: [ main ]
env:
  IMAGE_NAME: ${{ secrets.DOCKER_USER }}/sflask

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Docker login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_PASSWORD }}

      #run : docker login -u ${{ secrets.DOCKER_USR }} -p ${{ secrets.DOCKER_PASSWORD }}
      
    - name: Build the Docker image
      run: |
        IMAGE_TAG=${GITHUB_SHA::7}
        docker build -t $IMAGE_NAME:$IMAGE_TAG .
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        severity: CRITICAL,HIGH
        exit-code: '1'   # exit with error if vulnerabilities found
        ignore-unfixed: true
        vuln-type: 'os,library'
        format: 'table'
        output: 'trivy-report.md'
    
    - name: Push to docker hub
      if: success()
      run : |   
          docker push $IMAGE_NAME:${IMAGE_TAG}

    - name: Send deployment notification to ClickUp
      if: always()
      env:
        CLICKUP_WORKSPACE_ID: ${{ secrets.CLICKUP_WORKSPACE_ID }}
        CLICKUP_CHANNEL_ID: ${{ secrets.CLICKUP_CHANNEL_ID }}
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      run: |
          REPO_LINK="https://github.com/${GITHUB_REPOSITORY}"
          COMMIT_LINK="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          
          if [ "${{ job.status }}" = "success" ]; then
    
            STATUS_ICON="üü¢"
            STATUS_TEXT="SUCCESS"
            MESSAGE="#### Build Result Overview
            **Build Status :** ${STATUS_TEXT} ${STATUS_ICON} 
            **Repository :** [${GITHUB_REPOSITORY}](${REPO_LINK})  
            **Commit ID :** [${GITHUB_SHA::7}](${COMMIT_LINK})
            **Commit Message:** ${COMMIT_MESSAGE}
            **Description :** ${COMMIT_MESSAGE} on **${GITHUB_REF_NAME}** of \`${GITHUB_REPOSITORY}\`
            **Pushed By :** ${GITHUB_ACTOR}"
            
          else
            STATUS_ICON="üî¥"
            STATUS_TEXT="FAILURE"
            JOB_NAME="${{ github.job }}"
            FAIL_REASON="$JOB_NAME"
            REPORT=$(cat trivy-report.md || echo "No scan report available")
            MESSAGE="#### Build Result Overview
            **Build Status :** ${STATUS_TEXT} ${STATUS_ICON} 
            **Repository :** [${GITHUB_REPOSITORY}](${REPO_LINK})  
            **Commit ID :** [${GITHUB_SHA::7}](${COMMIT_LINK})
            **Commit Message:** ${COMMIT_MESSAGE}
            **Description :** ${COMMIT_MESSAGE} on **${GITHUB_REF_NAME}** of \`${GITHUB_REPOSITORY}\`
            **Pushed By :** ${GITHUB_ACTOR}
            **Failed On:** ${FAIL_REASON}
            ---
            ---

            #### üîç Trivy Scan Report
            \`\`\`md
            $REPORT
            \`\`\`"

          fi
          echo "MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$MESSAGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      
          curl --request POST \
            --url "https://api.clickup.com/api/v3/workspaces/${CLICKUP_WORKSPACE_ID}/chat/channels/${CLICKUP_CHANNEL_ID}/messages" \
            --header "Authorization: ${CLICKUP_API_TOKEN}" \
            --header "accept: application/json" \
            --header "content-type: application/json" \
            --data "$(jq -n \
              --arg type "message" \
              --arg content_format "text/md" \
              --arg content "$MESSAGE" \
              '{type: $type, content_format: $content_format, content: $content}')"
