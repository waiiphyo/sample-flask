name: Docker Image CI

on:
  push:
    branches: [ main ]
env:
  IMAGE_NAME: ${{ secrets.DOCKER_USER }}/sflask

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Docker login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_PASSWORD }}

      #run : docker login -u ${{ secrets.DOCKER_USR }} -p ${{ secrets.DOCKER_PASSWORD }}
      
    - name: Build the Docker image
      run: |
        IMAGE_TAG=${GITHUB_SHA::7}
        docker build -t $IMAGE_NAME:$IMAGE_TAG .
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        
    #- name: Install Trivy
    #  run: |
    #      sudo apt-get update
    #      sudo apt-get install -y wget gnupg lsb-release
    #      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
    #      echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
    #      sudo apt-get update
    #      sudo apt-get install -y trivy

    #- name: Create Markdown template
    #  run: |
    #      cat <<'EOT' > .github/trivy-markdown.tpl
    #      # Trivy Scan Report

    #      Target: {{ .ArtifactName }}

    #     | Library | Vulnerability | Severity | Installed | Fixed | Link |
    #      |---------|---------------|----------|-----------|-------|------|
    #      {{- range .Results }}
    #      {{- range .Vulnerabilities }}
    #      | {{ .PkgName }} | {{ .VulnerabilityID }} | {{ .Severity }} | {{ .InstalledVersion }} | {{ .FixedVersion }} | [Details]({{ .PrimaryURL }}) |
    #      {{- end }}
    #     {{ end }}
    #      EOT

    #- name: Scan docker image
    #  run: |
    #      trivy image ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
    #        --format template \
    #        --template "@.github/trivy-markdown.tpl" \
    #        -o trivy-report.md

    #     trivy image ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
    #       --format json -o trivy-report.json

    - name: Run Trivy scan (Markdown)
      uses: aquasecurity/trivy-action@0.21.0
      with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          severity: CRITICAL,HIGH
          exit-code: '1' 
          format: template
          template: "@.github/trivy-markdown.tpl"
          output: trivy-report.md

    # Run Trivy scan (JSON) for severity count
    - name: Run Trivy scan (JSON)
      if: always()
      uses: aquasecurity/trivy-action@0.21.0
      with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          severity: CRITICAL,HIGH
          format: json
          output: trivy-report.json

    - name: Count vulnerabilities by severity
      if: always()
      id: vuln
      run: |
          high=$(jq '[.. | .Severity? // empty | select(. == "HIGH")] | length' trivy-report.json)
          critical=$(jq '[.. | .Severity? // empty | select(. == "CRITICAL")] | length' trivy-report.json)

          echo "high=$high" >> $GITHUB_OUTPUT
          echo "critical=$critical" >> $GITHUB_OUTPUT

    - name: Upload Trivy report as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
          name: trivy-report
          path: trivy-report.md
          retention-days: 1
          
    - name: Generate Artifact URL
      if: always()
      id: artifact
      run: |
          run_id=${{ github.run_id }}
          repo=${{ github.repository }}
          echo "artifact_url=https://github.com/$repo/actions/runs/$run_id/artifacts" >> $GITHUB_OUTPUT

    - name: Push to docker hub
      if: success()
      run : |   
          docker push $IMAGE_NAME:${IMAGE_TAG}

    - name: Send deployment notification to ClickUp
      if: always()
      env:
        CLICKUP_WORKSPACE_ID: ${{ secrets.CLICKUP_WORKSPACE_ID }}
        CLICKUP_CHANNEL_ID: ${{ secrets.CLICKUP_CHANNEL_ID }}
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      run: |
          REPO_LINK="https://github.com/${GITHUB_REPOSITORY}"
          COMMIT_LINK="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          
          if [ "${{ job.status }}" = "success" ]; then
    
            STATUS_ICON="üü¢"
            STATUS_TEXT="SUCCESS"
            MESSAGE="#### Build Result Overview
            **Build Status :** ${STATUS_TEXT} ${STATUS_ICON} 
            **Repository :** [${GITHUB_REPOSITORY}](${REPO_LINK})  
            **Commit ID :** [${GITHUB_SHA::7}](${COMMIT_LINK})
            **Commit Message:** ${COMMIT_MESSAGE}
            **Description :** ${COMMIT_MESSAGE} on **${GITHUB_REF_NAME}** of \`${GITHUB_REPOSITORY}\`
            **Pushed By :** ${GITHUB_ACTOR}
            ### üê≥ Trivy Docker image scan completed 
            ** Image : ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            - üî¥ CRITICAL: **'${{ steps.vuln.outputs.critical }}'**
            - üü† HIGH: **'${{ steps.vuln.outputs.high }}'**"
            
          else
            STATUS_ICON="üî¥"
            STATUS_TEXT="FAILURE"
            JOB_NAME="${{ github.job }}"
            FAIL_REASON="$JOB_NAME"

            MESSAGE="#### Build Result Overview
            **Build Status :** ${STATUS_TEXT} ${STATUS_ICON} 
            **Repository :** [${GITHUB_REPOSITORY}](${REPO_LINK})  
            **Commit ID :** [${GITHUB_SHA::7}](${COMMIT_LINK})
            **Commit Message:** ${COMMIT_MESSAGE}
            **Description :** ${COMMIT_MESSAGE} on **${GITHUB_REF_NAME}** of \`${GITHUB_REPOSITORY}\`
            **Pushed By :** ${GITHUB_ACTOR}
            **Failed On:** ${FAIL_REASON}
            ### üê≥ Trivy Docker image scan completed
            ** Image : ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            - üî¥ CRITICAL: **'${{ steps.vuln.outputs.critical }}'**
            - üü† HIGH: **'${{ steps.vuln.outputs.high }}'**
            - üìÑ [Download full report]('${{ steps.artifact.outputs.url }}') (retained for 1 days)"
            
          fi
      
          curl --request POST \
            --url "https://api.clickup.com/api/v3/workspaces/${CLICKUP_WORKSPACE_ID}/chat/channels/${CLICKUP_CHANNEL_ID}/messages" \
            --header "Authorization: ${CLICKUP_API_TOKEN}" \
            --header "accept: application/json" \
            --header "content-type: application/json" \
            --data "$(jq -n \
              --arg type "message" \
              --arg content_format "text/md" \
              --arg content "$MESSAGE" \
              '{type: $type, content_format: $content_format, content: $content}')"
